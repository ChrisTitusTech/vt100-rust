#!/bin/sh
set -eux

rm -f target/release/* perf.* || true
if ! grep -q debug Cargo.toml; then
    cat >> Cargo.toml <<EOF

[profile.release]
debug = true
EOF
fi
cargo test --release --no-run
bin=$(find ./target/release -maxdepth 1 -name '*split_escape*' -not -name '*.d')
perf record -F99 --call-graph dwarf,16384 "$bin" --ignored
perf script > perf.script
perl ~/coding/src/FlameGraph/stackcollapse-perf.pl perf.script > perf.collapsed
perl ~/coding/src/FlameGraph/flamegraph.pl perf.collapsed > perf.svg
firefox perf.svg
